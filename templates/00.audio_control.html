<div id="audioControl">
    <span id="audioIcon">ðŸ”Š</span>
    <span id="tooltip">Now Playing: {{ song_name }}</span>
</div>

{% if song_file %}
<audio id="bgAudio" autoplay loop data-song="{{ song_name }}">
    <source src="{{ url_for('static', filename='audio/' + song_file) }}" type="audio/mp3">
</audio>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const audio = document.getElementById("bgAudio");
    const audioIcon = document.getElementById("audioIcon");
    const tooltip = document.getElementById("tooltip");
    const audioControl = document.getElementById("audioControl");

    if (!audio || !audioIcon || !tooltip || !audioControl) return;

    // Load saved mute state from localStorage
    let isMuted = localStorage.getItem("isMuted") === "true";
    audio.muted = isMuted;
    updateAudioControl(isMuted);

    // Attempt autoplay, fallback to user interaction
    const playPromise = audio.play();
    if (playPromise !== undefined) {
        playPromise.catch(() => {
            // If autoplay is blocked, play on first user interaction
            const playOnInteraction = () => {
                audio.play().catch(() => {});
                document.removeEventListener("click", playOnInteraction);
            };
            document.addEventListener("click", playOnInteraction);
        });
    }

    // Toggle mute/unmute
    audioControl.addEventListener("click", () => {
        audio.muted = !audio.muted;
        isMuted = audio.muted;
        localStorage.setItem("isMuted", isMuted);
        updateAudioControl(isMuted);
    });

    // Show tooltip on hover
    audioControl.addEventListener("mouseover", () => {
        tooltip.style.visibility = "visible";
        tooltip.style.opacity = "1";
    });
    audioControl.addEventListener("mouseout", () => {
        tooltip.style.visibility = "hidden";
        tooltip.style.opacity = "0";
    });

    function updateAudioControl(muted) {
        audioIcon.textContent = muted ? "ðŸ”‡" : "ðŸ”Š";
        tooltip.innerText = muted
            ? "Muted: Click to Play"
            : "Now Playing: " + (audio.dataset.song || "Audio");
    }
});
</script>
