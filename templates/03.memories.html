<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taekook Universe Galaxy</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="galaxyCanvas"></canvas>
<div class="tooltip" id="tooltip"></div>
<div id="eventsPanel"></div>
<div id="eventModal"></div>

<script>
const canvas = document.getElementById('galaxyCanvas');
const ctx = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');
const eventsPanel = document.getElementById('eventsPanel');
const eventModal = document.getElementById('eventModal');
const imageBasePath = "{{ url_for('static', filename='images/memories/') }}";

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const events = {{ events|tojson }};

const yearData = {};
events.forEach(ev=>{
  const [yearStr, monthStr] = ev.date.split('-');
  const year = parseInt(yearStr);
  const month = monthNames[parseInt(monthStr)-1];
  yearData[year] ??= { months: {} };
  yearData[year].months[month] ??= [];
  yearData[year].months[month].push(ev);
});

const galaxies = [];
const margin = 150;
const visibleWidth = canvas.width - margin*2;
const visibleHeight = canvas.height - margin*2;

Object.keys(yearData).sort().forEach(year=>{
  const x = margin + Math.random()*visibleWidth;
  const y = margin + Math.random()*visibleHeight;
  const monthEvents = yearData[year].months;
  const numEvents = Object.values(monthEvents).flat().length;
  const stars = Array.from({length:30 + numEvents*3},()=>({
    arm: Math.floor(Math.random()*3),
    radius: 20 + Math.random()*40,
    t: Math.random()*Math.PI*2,
    size: Math.random()*1.5 + 0.5,
    color: `hsla(${Math.random()*360}, 80%, 60%, ${Math.random()*0.7+0.3})`
  }));
  galaxies.push({year,x,y,numEvents,stars,arms:3,rotation:Math.random()*Math.PI*2,monthEvents});
});

const starsBg = Array.from({length:600},()=>({
  x:Math.random()*canvas.width,
  y:Math.random()*canvas.height,
  r:Math.random()*1.5,
  dx:(Math.random()-0.5)*0.05,
  dy:(Math.random()-0.5)*0.05
}));

function drawBackgroundStars(){
  ctx.fillStyle='#fff';
  starsBg.forEach(s=>{
    s.x+=s.dx; s.y+=s.dy;
    if(s.x<0)s.x=canvas.width; if(s.x>canvas.width)s.x=0;
    if(s.y<0)s.y=canvas.height; if(s.y>canvas.height)s.y=0;
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,2*Math.PI); ctx.fill();
  });
}

let selectedGalaxy=null;
let hoveredPlanet=null;

// store each planetâ€™s current rotation angle so we can freeze it
const planetAngles = {};

function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBackgroundStars();

  galaxies.forEach(g=>{
    g.rotation += 0.00005;
    if(selectedGalaxy && selectedGalaxy!==g) return;

    // Draw spiral arms
    g.stars.forEach(s=>{
      s.t += 0.0005;
      const angle = s.t + s.arm*2*Math.PI/g.arms + g.rotation;
      const r = s.radius * (1 + g.numEvents*0.02) + 10*Math.sin(s.t*2);
      const x = g.x + r*Math.cos(angle);
      const y = g.y + r*Math.sin(angle);
      const x2 = g.x + (r+5)*Math.cos(angle);
      const y2 = g.y + (r+5)*Math.sin(angle);
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(x2,y2);
      ctx.strokeStyle = s.color;
      ctx.lineWidth = s.size;
      ctx.stroke();
    });

    // Year label
    ctx.shadowColor="rgba(155,93,229,0.8)";
    ctx.shadowBlur=10;
    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.font=selectedGalaxy===g?`50px Orbitron`:`20px Orbitron`;
    ctx.fillText(g.year,g.x,g.y);
    ctx.shadowBlur=0;

    if(selectedGalaxy===g){
      const baseRadius=180, orbitSpacing=60;
      const months=Object.keys(g.monthEvents);
      months.forEach((month,i)=>{
        const num=g.monthEvents[month].length;
        const orbitR=baseRadius+i*orbitSpacing;
        const speed=0.00008+i*0.00002;

        // Freeze rotation when hovered
        const key=`${g.year}-${month}`;
        if(!(key in planetAngles)) planetAngles[key]=performance.now()*speed + i*Math.PI/6;
        if(hoveredPlanet && hoveredPlanet.year===g.year && hoveredPlanet.month===month){
          // don't change angle
        } else {
          planetAngles[key]=performance.now()*speed + i*Math.PI/6;
        }

        const angle=(planetAngles[key])%(2*Math.PI);
        const px=g.x+orbitR*Math.cos(angle);
        const py=g.y+orbitR*Math.sin(angle);
        const size=10+num*1.5;

        ctx.beginPath();
        ctx.arc(px,py,size,0,2*Math.PI);
        ctx.fillStyle = hoveredPlanet && hoveredPlanet.year===g.year && hoveredPlanet.month===month
          ? `hsl(${i*30},100%,75%)`
          : `hsl(${i*30},80%,60%)`;
        ctx.fill();

        ctx.fillStyle="#fff";
        ctx.font="20px Orbitron";
        ctx.fillText(month,px,py-size-8);
      });
    }
  });
  requestAnimationFrame(animate);
}
animate();

// Tooltip + Hover
canvas.addEventListener('mousemove',(e)=>{
  let found=false;
  hoveredPlanet=null;
  galaxies.forEach(g=>{
    if(selectedGalaxy && selectedGalaxy!==g) return;
    const dx=e.clientX-g.x, dy=e.clientY-g.y;
    if(Math.hypot(dx,dy)<30){
      tooltip.style.left=(e.pageX+10)+"px";
      tooltip.style.top=(e.pageY+10)+"px";
      tooltip.innerHTML=`Year: ${g.year} (${g.numEvents} events)`;
      tooltip.style.opacity=1; found=true;
    }
    if(selectedGalaxy===g){
      const baseR=180, orbitSpacing=60;
      Object.keys(g.monthEvents).forEach((month,i)=>{
        const num=g.monthEvents[month].length;
        const orbitR=baseR+i*orbitSpacing;
        const key=`${g.year}-${month}`;
        const angle=(planetAngles[key])%(2*Math.PI);
        const px=g.x+orbitR*Math.cos(angle);
        const py=g.y+orbitR*Math.sin(angle);
        if(Math.hypot(e.clientX-px,e.clientY-py)<12+num){
          hoveredPlanet={year:g.year,month};
          tooltip.style.left=(e.pageX+10)+"px";
          tooltip.style.top=(e.pageY+10)+"px";
          tooltip.innerHTML=`${month}: ${num} events`;
          tooltip.style.opacity=1; found=true;
        }
      });
    }
  });
  if(!found) tooltip.style.opacity=0;
});

</script>
</body>
</html>
